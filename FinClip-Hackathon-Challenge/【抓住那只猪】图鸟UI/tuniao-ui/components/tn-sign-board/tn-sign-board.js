(global["webpackJsonp"]=global["webpackJsonp"]||[]).push([["tuniao-ui/components/tn-sign-board/tn-sign-board"],{"36c7":function(t,e,i){"use strict";i.r(e);var n=i("4271"),a=i.n(n);for(var s in n)"default"!==s&&function(t){i.d(e,t,(function(){return n[t]}))}(s);e["default"]=a.a},4271:function(t,e,i){"use strict";(function(t){Object.defineProperty(e,"__esModule",{value:!0}),e.default=void 0;var n=a(i("a34a"));function a(t){return t&&t.__esModule?t:{default:t}}function s(t,e,i,n,a,s,r){try{var c=t[s](r),o=c.value}catch(h){return void i(h)}c.done?e(o):Promise.resolve(o).then(n,a)}function r(t){return function(){var e=this,i=arguments;return new Promise((function(n,a){var r=t.apply(e,i);function c(t){s(r,n,a,c,o,"next",t)}function o(t){s(r,n,a,c,o,"throw",t)}c(void 0)}))}}var c={name:"tn-sign-board",props:{show:{type:Boolean,default:!1},signSelectColor:{type:Array,default:function(){return["#080808","#E83A30"]}},rotate:{type:Boolean,default:!0},customBarHeight:{type:[String,Number],default:0}},data:function(){return{canvasName:"tn-sign-canvas",ctx:null,canvasWidth:0,canvasHeight:0,currentSelectColor:this.signSelectColor[0],firstTouch:!1,transparent:1,lineSize:1.5,minLine:.5,maxLine:4,pressure:1,smoothness:60,currentPoint:{},currentLine:[],radius:1,cutArea:{top:0,right:0,bottom:0,left:0},lastPoint:0,chirography:[],linePrack:[]}},watch:{show:function(t){var e=this;t&&0===this.canvasWidth&&0===this.canvasHeight&&this.$nextTick((function(){e.getCanvasInfo()}))},signSelectColor:function(t){t.length>0&&(this.currentSelectColor=t[0])}},created:function(){this.ctx=t.createCanvasContext(this.canvasName,this)},mounted:function(){},methods:{getCanvasInfo:function(){var t=this;this._tGetRect(".tn-sign-board__content__canvas").then((function(e){t.canvasWidth=e.width,t.canvasHeight=e.height,t.$nextTick((function(){t.initCanvas("#FFFFFF")}))}))},initCanvas:function(e){this.ctx.rect(0,0,this.canvasWidth-t.upx2px(4),this.canvasHeight-t.upx2px(4)),this.ctx.setFillStyle(e),this.ctx.fill(),this.ctx.draw()},onTouchStart:function(t){if("touchstart"!=t.type)return!1;this.ctx.setFillStyle(this.currentSelectColor),this.ctx.setGlobalAlpha(this.transparent);var e={x:t.touches[0].x,y:t.touches[0].y},i=this.currentLine;i.unshift({time:(new Date).getTime(),dis:0,x:e.x,y:e.y}),this.currentPoint=e,this.firstTouch&&(this.cutArea={top:e.y,right:e.x,bottom:e.y,left:e.x},this.firstTouch=!1),this.pointToLine(i)},onTouchMove:function(t){if("touchmove"!=t.type)return!1;t.cancelable&&(t.defaultPrevented||t.preventDefault());var e={x:t.touches[0].x,y:t.touches[0].y};e.y<this.cutArea.top&&(this.cutArea.top=e.y),e.y<0&&(this.cutArea.top=0),e.x<this.cutArea.right&&(this.cutArea.right=e.x),this.canvasWidth-e.x<=0&&(this.cutArea.right=this.canvasWidth),e.y>this.cutArea.bottom&&(this.cutArea.bottom=this.canvasHeight),this.canvasHeight-e.y<=0&&(this.cutArea.bottom=this.canvasHeight),e.x<this.cutArea.left&&(this.cutArea.left=e.x),e.x<0&&(this.cutArea.left=0),this.lastPoint=this.currentPoint,this.currentPoint=e;var i=this.currentLine;i.unshift({time:(new Date).getTime(),dis:this.distance(this.currentPoint,this.lastPoint),x:e.x,y:e.y}),this.pointToLine(i)},onTouchEnd:function(t){if("touchend"!=t.type)return!1;var e={x:t.changedTouches[0].x,y:t.changedTouches[0].y};this.lastPoint=this.currentPoint,this.currentPoint=e;var i=this.currentLine;i.unshift({time:(new Date).getTime(),dis:this.distance(this.currentPoint,this.lastPoint),x:e.x,y:e.y}),this.pointToLine(i);var n={lineSize:this.lineSize,lineColor:this.currentSelectColor},a=this.chirography;a.unshift(n),this.chirography=a;var s=this.linePrack;s.unshift(this.currentLine),this.linePrack=s,this.currentLine=[]},reDraw:function(){this.initCanvas("#FFFFFF")},save:function(){var e=this;t.canvasToTempFilePath({canvasId:this.canvasName,fileType:"png",quality:1,success:function(t){e.rotate?e.getRotateImage(t.tempFilePath).then((function(t){e.$emit("save",t)})).catch((function(t){e.$t.messageUtils.toast("旋转图片失败")})):e.$emit("save",t.tempFilePath)},fail:function(){e.$t.messageUtils.toast("保存失败")}},this)},previewImage:function(){var e=this;t.canvasToTempFilePath({canvasId:this.canvasName,fileType:"png",quality:1,success:function(i){e.rotate?e.getRotateImage(i.tempFilePath).then((function(e){t.previewImage({urls:[e]})})).catch((function(t){e.$t.messageUtils.toast("旋转图片失败")})):t.previewImage({urls:[i.tempFilePath]})},fail:function(t){e.$t.messageUtils.toast("预览失败")}},this)},closeBoard:function(){var t=this;this.$t.messageUtils.modal("提示信息","关闭后内容将被清除，是否确认关闭",(function(){t.$emit("closed")}),!0)},colorSwitch:function(t){this.currentSelectColor=t},pointToLine:function(t){this.calcBethelLine(t)},calcBethelLine:function(t){if(t.length<=1)t[0].r=this.radius;else{var e,i,n,a,s,r,c,o,h,u,l=0,f=0,x=.5;t.length<=2?(e=t[1].x,a=t[1].y,n=t[1].x+(t[0].x-t[1].x)*x,r=t[1].y+(t[0].y-t[1].y)*x,i=e+(n-e)*x,s=a+(r-a)*x):(e=t[2].x+(t[1].x-t[2].x)*x,a=t[2].y+(t[1].y-t[2].y)*x,i=t[1].x,s=t[1].y,n=i+(t[0].x-i)*x,r=s+(t[0].y-s)*x),h=this.distance({x:n,y:r},{x:e,y:a}),u=this.radius;for(var y=0;y<t.length-1;y++)if(l+=t[y].dis,f+=t[y].time-t[y+1].time,l>this.smoothness)break;this.radius=Math.min(f/h*this.pressure+this.minLine,this.maxLine)*this.lineSize,t[0].r=this.radius,t.length<=2?(c=(u+this.radius)/2,o=c,o):(c=(t[2].r+t[1].r)/2,o=t[1].r,(t[1].r+t[0].r)/2);for(var d=5,v=[],m=0;m<d;m++){var p=m/(d-1),g=(1-p)*(1-p)*e+2*p*(1-p)*i+p*p*n,F=(1-p)*(1-p)*a+2*p*(1-p)*s+p*p*r,P=u+(this.radius-u)/d*m;if(v.push({x:g,y:F,r:P}),3===v.length){var T=this.ctaCalc(v[0].x,v[0].y,v[0].r,v[1].x,v[1].y,v[1].r,v[2].x,v[2].y,v[2].r);T[0].color=this.currentSelectColor,this.drawBethel(T,!0),v=[{x:g,y:F,r:P}]}}this.currentLine=t}},distance:function(t,e){var i=e.x-t.x,n=e.y-t.y;return Math.sqrt(i*i+n*n)},ctaCalc:function(t,e,i,n,a,s,r,c,o){var h,u,l,f,x,y,d,v,m,p=[];h=n-t,u=a-e,l=2*Math.sqrt(h*h+u*u+1e-4),h=h/l*i,u=u/l*i,f=u,x=-h,y=n-r,d=a-c,l=2*Math.sqrt(y*y+d*d+1e-4),y=y/l*o,d=d/l*o,v=-d,m=y,p.push({mx:t+f,my:e+x,color:"#080808"}),p.push({c1x:n+f,c1y:a+x,c2x:n+v,c2y:a+m,ex:r+v,ey:c+m}),p.push({c1x:r+v-y,c1y:c+m-d,c2x:r-v-y,c2y:c-m-d,ex:r-v,ey:c-m}),p.push({c1x:n-v,c1y:a-m,c2x:n-f,c2y:a-x,ex:t-f,ey:e-x}),p.push({c1x:t-f-h,c1y:e-x-u,c2x:t+f-h,c2y:e+x-u,ex:t+f,ey:e+x}),p[0].mx=p[0].mx.toFixed(1),p[0].mx=parseFloat(p[0].mx),p[0].my=p[0].my.toFixed(1),p[0].my=parseFloat(p[0].my);for(var g=1;g<p.length;g++)p[g].c1x=p[g].c1x.toFixed(1),p[g].c1x=parseFloat(p[g].c1x),p[g].c1y=p[g].c1y.toFixed(1),p[g].c1y=parseFloat(p[g].c1y),p[g].c2x=p[g].c2x.toFixed(1),p[g].c2x=parseFloat(p[g].c2x),p[g].c2y=p[g].c2y.toFixed(1),p[g].c2y=parseFloat(p[g].c2y),p[g].ex=p[g].ex.toFixed(1),p[g].ex=parseFloat(p[g].ex),p[g].ey=p[g].ey.toFixed(1),p[g].ey=parseFloat(p[g].ey);return p},drawBethel:function(t,e,i){this.ctx.beginPath(),this.ctx.moveTo(t[0].mx,t[0].my),void 0!=i?(this.ctx.setFillStyle(i),this.ctx.setStrokeStyle(i)):(this.ctx.setFillStyle(t[0].color),this.ctx.setStrokeStyle(t[0].color));for(var n=1;n<t.length;n++)this.ctx.bezierCurveTo(t[n].c1x,t[n].c1y,t[n].c2x,t[n].c2y,t[n].ex,t[n].ey);this.ctx.stroke(),void 0!=e&&this.ctx.fill(),this.ctx.draw(!0)},getRotateImage:function(e){var i=this;return r(n.default.mark((function a(){var s,r,c,o;return n.default.wrap((function(n){while(1)switch(n.prev=n.next){case 0:return s=e,r=t.createCanvasContext("temp-tn-sign-canvas",i),c=i.canvasWidth,o=i.canvasHeight,r.restore(),r.save(),r.translate(0,o),r.rotate(270*Math.PI/180),r.drawImage(s,0,0,c,o),r.draw(),n.abrupt("return",new Promise((function(e,n){setTimeout((function(){t.canvasToTempFilePath({canvasId:"temp-tn-sign-canvas",fileType:"png",x:0,y:o-c,width:o,height:c,success:function(t){return e(t.tempFilePath)},fail:n},i)}),50)})));case 11:case"end":return n.stop()}}),a)})))()},base64ToPath:function(e){return new Promise((function(i,n){if(-1!==e.indexOf("base64")){var a=t.base64ToArrayBuffer(e.replace(/^data:image\/\w+;base64,/,"")),s="".concat(wx.env.USER_DATA_PATH,"/").concat((new Date).getTime(),"-").concat(Math.random().toString(32).slice(2),".png");t.getFileSystemManager().writeFile({filePath:s,data:a,encoding:"base64",success:function(){return i(s)},fail:n})}else i(e)}))}}};e.default=c}).call(this,i("543d")["default"])},"459a":function(t,e,i){"use strict";i.r(e);var n=i("8321"),a=i("36c7");for(var s in a)"default"!==s&&function(t){i.d(e,t,(function(){return a[t]}))}(s);i("5ed0");var r,c=i("f0c5"),o=Object(c["a"])(a["default"],n["b"],n["c"],!1,null,"355bd2e4",null,!1,n["a"],r);e["default"]=o.exports},"4f3e":function(t,e,i){},"5ed0":function(t,e,i){"use strict";var n=i("4f3e"),a=i.n(n);a.a},8321:function(t,e,i){"use strict";var n;i.d(e,"b",(function(){return a})),i.d(e,"c",(function(){return s})),i.d(e,"a",(function(){return n}));var a=function(){var t=this,e=t.$createElement;t._self._c},s=[]}}]);
;(global["webpackJsonp"] = global["webpackJsonp"] || []).push([
    'tuniao-ui/components/tn-sign-board/tn-sign-board-create-component',
    {
        'tuniao-ui/components/tn-sign-board/tn-sign-board-create-component':(function(module, exports, __webpack_require__){
            __webpack_require__('543d')['createComponent'](__webpack_require__("459a"))
        })
    },
    [['tuniao-ui/components/tn-sign-board/tn-sign-board-create-component']]
]);
